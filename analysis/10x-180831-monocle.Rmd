---
title: "R Notebook"
output:
  html_document:
    df_print: paged
    toc: true
    toc_float: 
      smooth_scroll: true
---

```{r}
library(Seurat)
library(monocle)
library(pheatmap)
seurobj <- readRDS('output/10x-180831')
```


#Feature selection strategies

Genes with high dispersion

```{r}
cds_high_disp <- readRDS('output/monocle/180831/monocle_high_dispersion/10x-180831-monocle')
plot_cell_trajectory(cds_high_disp, color_by = 'timepoint')
```

DE genes between T1T2T3 and T4T5

```{r}
cds_timecombined <- readRDS('output/monocle/180831/monocle_time-combined/10x-180831-monocle')
plot_cell_trajectory(cds_timecombined, color_by='timepoint')
```

DE genes from cluster resolution 1.5

```{r}
cds_res1.5 <- readRDS('output/monocle/180831/monocle_res1.5/10x-180831-monocle')
plot_cell_trajectory(cds_res1.5, color_by='timepoint')
```

Dataset split into T1+T2+T3 and T4+T5, DE genes from clusters res0.5.

```{r}
cds_split_res0.5 <- readRDS('output/monocle/180831/monocle_T1T2T3_T4T5_res0.5/10x-180831-noreg-monocle')
plot_cell_trajectory(cds_split_res0.5, color_by='timepoint')
```

Dataset split into T1+T2+T3 and T4+T5, DE genes from clusters res1.5 are used here. This trajectory was used for further analyses.

```{r}
cds <- readRDS('output/monocle/180831/monocle_T1T2T3_T4T5_res1.5/10x-180831-monocle')
plot_cell_trajectory(cds, color_by='timepoint')
```

#Trajectory plots

```{r fig1, fig.height = 16, fig.width = 5, fig.align = "center"}
fig <- plot_grid(ncol=1,
  plot_cell_trajectory(cds, color_by='timepoint'),
  plot_cell_trajectory(cds, color_by='Pseudotime'),
  plot_cell_trajectory(cds, color_by='State'),
  plot_cell_trajectory(cds, color_by = "State") + scale_color_manual(values=c("#f67770", "#964B00", "orange"), name = "State"))

fig
```


```{r}
plot_cell_trajectory(cds, color_by = "timepoint") + geom_point(color='white', size=5) + geom_point(aes(colour=timepoint), alpha=0.1)
```

```{r}
plot_cell_trajectory(cds, color_by = "timepoint") + geom_point(color='white', size=5) + geom_point(aes(colour=timepoint), alpha=0.01)
```

```{r}
#seurobj <- AddMetaData(seurobj, pData(cds)['State'])
#saveRDS(seurobj, 'output/10x-180831')
```

#BEAM

BEAM takes as input a CellDataSet that's been ordered with orderCells and the name of a branch point in the trajectory. It returns a table of significance scores for each gene. Genes that score significant are said to be branch-dependent in their expression.

```{r}
#BEAM_res <- BEAM(cds, branch_point = 1, cores = 10)
load('output/monocle/180831/BEAM')
BEAM_res <- BEAM_res[order(BEAM_res$qval),]
BEAM_res <- BEAM_res[,c("gene_short_name", "pval", "qval")]
```


```{r}
paste('Significant genes with q-val < 0.01:', length(BEAM_res$qval[BEAM_res$qval < 0.05]))
paste('Significant genes with q-val < 0.01:', length(BEAM_res$qval[BEAM_res$qval < 0.01]))
paste('Significant genes with q-val < 0.001:', length(BEAM_res$qval[BEAM_res$qval < 0.001]))
paste('Significant genes with q-val < 0.0001:', length(BEAM_res$qval[BEAM_res$qval < 0.0001]))
paste('Significant genes with q-val < 0.00001:', length(BEAM_res$qval[BEAM_res$qval < 0.00001]))
paste('Significant genes with q-val = 0:', length(BEAM_res$qval[BEAM_res$qval == 0]))
```

Histograms of p-values and q-values

```{r}
hist(BEAM_res$pval)
```

```{r}
hist(BEAM_res$qval)
```

#Filtering BEAM results on fold change

```{r}
matrix <- as.matrix(seurobj@data)
calculateAvgLogFC <- function(gene){
  gene <- as.character(gene)
    state2 <- log1p(mean(expm1(as.numeric(matrix[gene, row.names(seurobj@meta.data)[seurobj@meta.data$State == 2]])))) # first un-log transform. then average. then logp1 again. This is all done to calculate the mean in non-log-space.
  state3 <- log1p(mean(expm1(as.numeric(matrix[gene, row.names(seurobj@meta.data)[seurobj@meta.data$State == 3]]))))
  return(state2-state3)
}

BEAM_signficnat_res <- BEAM_res[BEAM_res$qval < 0.05,]
BEAM_signficnat_res$avgLogFC_State2_State3 <- sapply(BEAM_signficnat_res$gene_short_name, calculateAvgLogFC)
```

X axis = minimum log fold change.

```{r}
all <- c()
values <- list()
for (i in seq(0.0, 3, by=0.1)){
  fc <- abs(BEAM_signficnat_res$avgLogFC_State2_State3[abs(BEAM_signficnat_res$avgLogFC_State2_State3) >= i])
  all <- c(all, fc)
  values[toString(i)] <- length(fc)
}
hist(all, breaks=20, probability = F)
```

```{r}
hist(all, breaks=20, probability = T)
lines(density(all), col='blue', lwd=2)
```

```{r}
data.frame(fold_change=names(values), num_genes=unlist(values))
```

#BEAM heatmap

Create heatmap of the significant genes with absolute average logFC > 0.3.

```{r}
#ran in terminal because of computation time
#branched_5 <- plot_genes_branched_heatmap(cds[row.names(subset(BEAM_signficnat_res, abs(avgLogFC_State2_State3) > 0.3))],
#                                         branch_point = 1,
#                                         num_clusters = 5,
#                                         cores = 10,
#                                         show_rownames = F,
#                                       return_heatmap = T,
#                                       branch_labels = c("Cell fate 1 (State 2)", "Cell fate 2 #(State 3)"),
#                                       branch_colors = c('#f67770', '#1bb840', '#649efc')
#                                       )
```

```{r}
load('output/monocle/180831/branched')
```

You can visualize changes for all the genes that are significantly branch dependent using a special type of heatmap. This heatmap shows changes in both lineages at the same time. It also requires that you choose a branch point to inspect. Columns are points in pseudotime, rows are genes, and the beginning of pseudotime is in the middle of the heatmap. As you read from the middle of the heatmap to the right, you are following one lineage through pseudotime. As you read left, the other. The genes are clustered hierarchically, so you can visualize modules of genes that have similar lineage-dependent expression patterns.


```{r fig20, fig.height = 7, fig.width = 6, fig.align = "center"}
grid::grid.draw(branched_5$ph_res$gtable)
```

Nr of genes

```{r}
print_nGene <- function(branched){
  print(paste('Total number of genes:', length(branched$annotation_row$Cluster)))
  for (i in 1:length(unique(branched$annotation_row$Cluster))){
    cluster <- rownames(branched$annotation_row)[branched$annotation_row$Cluster == i]
    print(paste('Nr of genes in cluster ', i, ': ', length(cluster), sep=''))
  }
}

print('For logFC 0.3:')
print_nGene(branched_5)
```


Write BEAM results to files

```{r}
for (i in 1:length(unique(branched_5$annotation_row$Cluster))){
  BEAM_cluster <- BEAM_signficnat_res[BEAM_signficnat_res$gene_short_name %in% row.names(branched_5$annotation_row)[branched_5$annotation_row == i],]
  BEAM_cluster <- BEAM_cluster[order(-BEAM_cluster$avgLogFC_State2_State3),]
  write.table(BEAM_cluster, paste('tables/BEAM/genelist_cluster_', i, '.txt', sep=''), row.names=F, quote=F, sep='\t')
}  
```


##Genes plotted over pseudotime

C/EBPa more important in white. C/EBPb and C/EBPd more important in brown (described in several reviews). Weird to see it the other way around in our data.

```{r fig10, fig.height = 15, fig.width = 10, fig.align = "center"}

cds_subset <- cds[row.names(subset(fData(cds), gene_short_name %in% c('EBF2', 'PDGFRA', 'PDGFRB', 'PPARG', 'MALAT1', 'NEAT1', 'PRDM16', 'CEBPA', 'CEBPB', 'CEBPD', 'UCP1', 'LEP'))),]

p2 <- plot_genes_branched_pseudotime(cds_subset, branch_point = 1, color_by = "timepoint", ncol = 2)
p2
#save_plot("../plots/180831_monocle_genes-in-pseudotime-2.pdf", p2, base_width=10, base_height=18)
```

Pseudotime figures report

```{r fig5, fig.height = 9, fig.width = 10, fig.align = "center"}
cds_subset <- cds[row.names(subset(fData(cds), gene_short_name %in% c("IGF2", 'CD36', 'CIDEC', 'PLIN4', 'UCP1', 'UCP2'))),]

p1 <- plot_genes_branched_pseudotime(cds_subset, branch_point = 1, color_by = "timepoint", ncol = 2)
p1
#save_plot("../plots/180831_monocle_genes-in-pseudotime.pdf", p1, base_width=10, base_height=9)
```

#Figures for report

```{r fig4, fig.height = 5, fig.width = 12, fig.align = "center"}
fig <- plot_grid(
  plot_cell_trajectory(cds, color_by='timepoint'),
  plot_cell_trajectory(cds, color_by='Pseudotime'),
  labels='auto', nrow=1
)
#save_plot("../plots/180831_monocle_timepoint_pseudotime.pdf", fig, base_width=12, base_height=5)
fig
```

```{r fig3, fig.height = 5, fig.width = 6, fig.align = "center"}
fig2 <- plot_grid(plot_cell_trajectory(cds, color_by='State'), labels=c('d'))
#save_plot("../plots/180831_monocle_state.pdf", fig2, base_width=6, base_height=5)
fig2
```

```{r fig2, fig.height = 7, fig.width = 6, fig.align = "center"}
grid::grid.draw(branched_5$ph_res$gtable)
#save_plot('../plots/180831_beam_heatmap.pdf', branched_5$ph_res$gtable, base_width=6, base_height=7)
```

Supplementary figures

```{r fig9, fig.height = 10, fig.width = 12, fig.align = "center"}
sfig <- plot_grid(
  plot_cell_trajectory(cds_high_disp, color_by='timepoint'),
  plot_cell_trajectory(cds_timecombined, color_by='timepoint'),
  plot_cell_trajectory(cds_res1.5, color_by='timepoint'),
  plot_cell_trajectory(cds, color_by='timepoint'),
  labels='auto', nrow=2
)
#save_plot("../plots/supplementary_figures/sfig_180831_monocle_highdisp_timecombined_res1.5_split-res1.5.pdf", sfig, base_width=12, base_height=10)
sfig
```

```{r}
sfig2 <- qplot(BEAM_res$qval, geom="histogram", xlab='q-value', ylab='Number of genes')
save_plot("../plots/supplementary_figures/sfig_180831_beam_qval_hist.pdf", sfig2, base_width=6, base_height=5)
```

