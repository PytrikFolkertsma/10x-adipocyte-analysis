---
title: "R Notebook"
output: html_notebook
---


```{r}
library(Seurat)
library(monocle)
library(dplyr)
```

```{r}
seurobj <- readRDS('../output/seurat_objects/180831/10x-180831')
cds <- readRDS('output/monocle/180831/10x-180831-monocle-monocle_genelist_T1T2T3_T4T5_res.1.5')
t1_aligned <- readRDS('../output/seurat_objects/180504/10x-180504-ccregout-aligned')
source('code/colors.R')
```

#Figure 1

```{r echo=T, results='hide', include=F}
p1 <- TSNEPlot(seurobj, group.by='depot', colors.use=colors.depots, pt.size=pt.size.tsne, no.axes=T)
p2 <- TSNEPlot(seurobj, group.by='timepoint', colors.use=colors.timepoints, pt.size=0.5, no.axes=F, do.return=T) + theme(axis.text = element_blank(), axis.ticks = element_blank(), axis.title = element_blank(), plot.margin=grid::unit(c(0,0,0,0), "mm"))
p3 <- TSNEPlot(t1_aligned, group.by='depot', colors.use=colors.depots, do.return=T, pt.size=pt.size.tsne, no.axes=T)

fig1 <- plot_grid(p1, p2, p3, ncol=2)
```

```{r, fig.height = 10, fig.width = 12, fig.align = "center"}
fig1
```

```{r}
save_plot("../figures/figures_paper/main_figures/figure1/10x-180831_tsne_depots.pdf", p1, base_width=6, base_height=4.5)
save_plot("../figures/figures_paper/main_figures/figure1/10x-180831_tsne_timepoints.pdf", p2, base_width=4, base_height=3)
save_plot("../figures/figures_paper/main_figures/figure1/10x-180831_tsne_t1_aligned.pdf", p3, base_width=6, base_height=4.5)
```


#Figure 2

```{r echo=T, results='hide', include=F}
#10x-180831_tsne_depots
#10x-180831_tsne_timepoints
#10x-180831_trajectory_depots
#10x-180831_trajectory_timepoints
#10x-180831_tsne_state

p3 <- plot_cell_trajectory(cds, color_by='depot') + scale_color_manual(values=colors.depots, name='Depot')
p4 <- plot_cell_trajectory(cds, color_by = "timepoint") + geom_point(color='white', size=5) + geom_point(aes(colour=timepoint), alpha=0.1) + scale_color_manual(values=colors.timepoints)
p5 <- TSNEPlot(seurobj, group.by='State.labels', colors.use=colors.states.labels, no.axes=T)

fig2 <- plot_grid(
  p3, p4, p5, ncol=2
)
```

```{r, fig.height = 8, fig.width = 12, fig.align = "center"}
fig2
```


```{r echo=T, results='hide', include=F}
save_plot("figures/figures_paper/main_figures/figure2/10x-180831_trajectory_depots.pdf", p3, base_width=6, base_height=4.5)
save_plot("figures/figures_paper/main_figures/figure2/10x-180831_trajectory_timepoints.pdf", p4, base_width=6, base_height=4.5)
save_plot("../figures/figures_paper/main_figures/figure2/10x-180831_tsne_state.pdf", p5, base_width=6, base_height=4.5)
```


#Figure 3

Heatmap

```{r, fig.height = 7, fig.width = 6, fig.align = "center"}
load('../output/monocle/180831/heatmaps')
heatmap <- heatmaps$heatmap_logFC0.3_ncluster6_filtered_genes
gridExtra::grid.arrange(heatmap$ph_res$gtable)
```

```{r}
save_plot("../figures/figures_paper/main_figures/figure3/BEAM_heatmap_logFC0.3_ncluster6_filtered_genes.pdf", heatmap$ph_res$gtable, base_width=7, base_height=8)
```

Pseudotime plots

```{r}
#new_cds <- buildBranchCellDataSet(cds, progenitor_method='duplicate', branch_states=c(2,3), branch_point=1, branch_labels=c('Metabolic', 'ECM'), stretch=T)
#saveRDS(new_cds, file='../output/monocle/180831/10x-180831-monocle-monocle_genelist_T1T2T3_T4T5_res.1.5_duplicated-progenitor_stretched-pseudotime')

new_cds <- readRDS('../output/monocle/180831/10x-180831-monocle-monocle_genelist_T1T2T3_T4T5_res.1.5_duplicated-progenitor_stretched-pseudotime')
#new cds contains duplicated progenitor cells (one assigned to each branch) and stretched Pseudotime

df_pdata <- pData(new_cds)[c('original_cell_id', 'Branch', 'State.labels', 'Pseudotime')]

#get expression values for every cell ID from the new cds
genes <- as.matrix(t(seurobj@data[c('ADIPOQ', 'MGP', 'UCP2', 'DCN', 'APOD'), df_pdata$original_cell_id]))

#cbind the expression values with the relevant metadata
df <- cbind(df_pdata, as.data.frame(genes))
```


```{r, fig.height = 8, fig.width = 10, fig.align = "center"}
plot_pseudotime <- function(gene){
  p <- ggplot(df, aes_string(x='Pseudotime', y=gene)) +
    geom_point(shape = 21, colour = "black", size = 1, stroke = 0, alpha=0.1, aes(fill=State.labels), show.legend=F) +
    geom_smooth(se = FALSE, aes(color=Branch), span=0.9, method='loess') +
    scale_color_manual(values=colors.pseudotime.lines) +
    scale_fill_manual(values=colors.pseudotime.points) +
    scale_y_continuous(minor_breaks=1) +
    xlab('Pseudotime (stretched)') +
    ggtitle(gene) +
    theme(plot.title = element_text(size=20))
  return(p)
}

adipoq_pt <- plot_pseudotime('ADIPOQ')
ucp2_pt <- plot_pseudotime('UCP2')
dcn_pt <- plot_pseudotime('DCN')
apod_pt <- plot_pseudotime('APOD')

plot_grid(adipoq_pt, ucp2_pt, dcn_pt, apod_pt, ncol=2)
```

```{r}
save_plot("../figures/figures_paper/main_figures/figure3/pseudotime_ADIPOQ.pdf", adipoq_pt, base_width=5, base_height=6)
save_plot("../figures/figures_paper/main_figures/figure3/pseudotime_UCP2.pdf", ucp2_pt, base_width=5, base_height=6)
save_plot("../figures/figures_paper/main_figures/figure3/pseudotime_DCN.pdf", dcn_pt, base_width=5, base_height=6)
save_plot("../figures/figures_paper/main_figures/figure3/pseudotime_APOD.pdf", apod_pt, base_width=5, base_height=6)
```

Featureplots

```{r echo=T, results='hide'}
featureplots <- FeaturePlot(seurobj, features.plot=c('ADIPOQ', 'UCP2', 'DCN', 'APOD'), cols.use=c('gray', 'blue'), no.legend=F, do.return=T, no.axes=T) 

adipoq_fp <- featureplots$ADIPOQ + theme(plot.title=element_blank())
ucp2_fp <- featureplots$UCP2 + theme(plot.title=element_blank())
dcn_fp <- featureplots$DCN + theme(plot.title=element_blank())
apod_fp <- featureplots$APOD + theme(plot.title=element_blank())
```

```{r, fig.height = 8, fig.width = 10, fig.align = "center"}
plot_grid(adipoq_fp, ucp2_fp, dcn_fp, apod_fp, ncol=2)
```


```{r}

save_plot("../figures/figures_paper/main_figures/figure3/pseudotime_ADIPOQ_MGP.pdf", pseudotime + scale_color_manual(values=colors.states, labels=c("Progenitor", "Upper", "Lower"), name='Branch'), base_width=5, base_height=6)
save_plot("../figures/figures_paper/main_figures/figure3/featureplots_ADIPOQ_MGP.pdf", featureplots + theme(axis.text=element_blank(), axis.ticks=element_blank(), axis.title=element_blank()), base_width=4, base_height=6)
```

#Figure 3b

```{r}
#GO bubble plot
name <- 'heatmap_logFC0.3_ncluster6'
folder <- paste('tables/BEAM/', name, sep='')
clusters <- c(1,2,3,4,6)
gsea <- list()
genelist <- list()

for (i in clusters){
  gsea_cluster <- read.table(paste(folder, '/REVIGO_cleaned/', 'REVIGO_cluster', i, '_cleaned.tsv', sep=''), header=T)
  gsea_cluster['cluster'] <- i
  genes_cluster <- read.table(paste(folder, '/genelist_cluster', i, '.tsv', sep=''), header=T)
  gsea[[i]] <- gsea_cluster
  genelist[[i]] <- genes_cluster
}

gsea <- do.call("rbind", gsea)
genelist <- do.call("rbind", genelist)

create_terms <- function(gsea){
  return(data.frame(category=gsea$gsea.domain, ID=gsea$revigo.term_ID, term=gsea$revigo.description, adj_pval=gsea$gsea.p.value, genes=gsea$gsea.intersection, cluster=gsea$cluster))
}

create_genes <- function(genelist){
  return(data.frame(ID=genelist$gene_short_name, logFC=genelist$avgLogFC_State2_State3))
}

terms <- create_terms(gsea)
genes <- create_genes(genelist)
circ <- circle_dat(terms, genes)

```

```{r, fig.height = 12, fig.width = 25, fig.align = "center"}
bubble <- gridExtra::grid.arrange(GOBubble(circ, labels=3, ID=F, table.legend=F))
bubble
```

```{r}
save_plot('figures/figures_paper/main_figures/figure3/GObubble.pdf', bubble, base_width=18, base_height=10)
```

#SOM Figures

TF analysis

```{r}

```


Metabolic and ECM genes

```{r}

```



